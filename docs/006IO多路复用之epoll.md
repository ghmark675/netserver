# 代码优化

部分代码优化是为了将来开发Reactor服务器做准备

## 设置listenfd属性

1. `SO_REUSEADDR`:端口复用。允许一个端口在关闭后立即重新绑定，不用等待`TIME_WAIT`状态结束
2. `TCP_NODELAY`:禁用Nagle算法，允许小数据包立即发送，不等待数据积累
3. `SO_REUSEPORT`:允许多个进程/线程监听一个端口，系统自动负载均衡到不同进程/线程
4. `SO_KEEPALIVE`:在空闲时周期性发送探测包检测连接是否存活

# epoll
用`eventpoll`对象作为socket和进程之间的中介

- 代替进程**被添加到socket等待队列**
- 维护`rdlist`(双向链表)，用于引用有事件发生的socket
- 维护监视socket列表使用红黑树

|        | 水平触发                                                                                                               | 边缘触发                                                                                                                                                  |
| ------ | ---------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 读事件 | 如果`epoll_wait`触发了读事件，表示有数据可读，如果程序没有把数据读完，再次调用`epoll_wait`的时候，将立即再次触发读事件 | `epoll_wait`触发读事件后，不管程序有没有处理读事件，`epoll_wait`都不会再触发读事件，只有当新的数据到达时，才再次触发读事件。                              |
| 写事件 | 如果发送缓冲区没有满，表示可以写入数据，只要缓冲区没有被写满，再次调用`epoll_wait`的时候，将立即再次触发写事件         | `poll_wait`触发写事件之后，如果发送缓冲区仍可以写（发送缓冲区没有满），`epoll_wait`不会再次触发写事件，只有当发送缓冲区由满变成不满时，才再次触发写事件。 |

epoll具体原理不再多说，附上一篇讲的很清楚的文章`006epoll原理.docx`